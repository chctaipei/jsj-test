%META:TOPICINFO{author="HsienChien" comment="" date="1448963036" format="1.1" reprev="2" version="2"}%
%META:TOPICPARENT{name="EcommerceHome"}%
---+!! EC Search 設計文件2 - 熱門關鍵字, 模糊, 同音, auto-complete

修改紀錄
| *更新時間* | *內容* |
| 2015-12-1 | 第一版 |
---

%TOC%

---
---++ 介紹

熱門關鍵字, 模糊, 同音, auto-complete 的來源是 query log 裡面的關鍵字, 關鍵字會在搜尋時被記錄在 database

紀錄的搜尋條件為:
   * *關鍵字不含特殊布林字元*
   * *第一頁*
   * *沒有過濾(價格,分類,品牌,標籤)*
   * *結果不為空*

---
---++ 技術

[[HotQueryLogic]["Most Heavily Used" Cache]] - 這技術是用來偵測區間內最常被使用的行為, 對象可以是來源, 也可以是內容, 或者任何可以識別的特徵, 它所需要的硬體資源低, 反應即時且快速, 準確率高, 因此很適合使用來做為判斷關鍵字是否熱門

| *欄位名稱* | *說明* |
| id | 識別號(數字) |
| query | 關鍵字 |
| count | 查詢數(累計) |
| matches | 搜尋結果 |
| create_time | 建立時間 |
| update_time | 更新時間 |
| score | 分數 |

   * 因為 count 與 score 性質相同, 因此只取 count 當作計算分數, 省略 score
   * 為避免 count 無限累計造成失準, 需要設定重置或上限值, 例如我們如果需要的是一週內的區間, 則將一週外的資料做 normalization (ps: count/N * 7)
      * %RED%目前尚未使用 normalization, 因此重置後第一天可能有失真的現象%ENDCOLOR%
      * %RED%列為後續研究改善計畫%ENDCOLOR%

| *參數* | *設定值* | *說明* |
| TABLESIZE | 10000 | 表格大小, 可以記錄 query 數目的上限 |
| MAXSCORE | 0 | 分數上限, 0 為無上限 (採其他機制) |
| CHECK_WEEKDAY | 1 | 於星期一上午四點重置 |
| CHECK_TIME | 4 | 於星期一上午四點重置 |
| DICSIZE | 6000 | 取 6000 熱門查詢放到 elastic search, 作為同音及fuzzy使用 |
| SYNC_TIME | 3 | 同音表於星期一上午三點更新, *必須早於重置時間* |

---
---++ DB Schema
---+++ !QueryLog Table

即時記錄關鍵字搜尋, 作為熱門關鍵字, 相關關鍵字及關鍵字更正建議使用
<sticky>
%CODE{lang="sql" [num="10"]}% 
Create Table: CREATE TABLE `QueryLog` (
  `id` int(11) NOT NULL DEFAULT '0',
  `query` varchar(128) DEFAULT NULL,
  `count` int(11) unsigned NOT NULL DEFAULT '0',
  `matches` int(11) unsigned NOT NULL DEFAULT '0',
  `create_time` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
  `update_time` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
  PRIMARY KEY (`id`),
  UNIQUE KEY `query_UNIQUE` (`query`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8
%ENDCODE%</sticky>

---
---++ 模糊/同音搜尋

用關鍵字搜尋近似或同音關鍵字, 用在查無資料時提供建議

作法:
   1 從 !QueryLog 將關鍵字轉換成同音字輸入 Elastic Search Server
   1 查詢時, 要將關鍵字過濾並轉成同音後向 Elastic Server 查詢

其他:
   1 matches, count 原構想作為排序使用, 但會影響 fuzziness 的預設排序, 結果會變差, 因此目前暫時用不到
   1 參考 [[https://www.elastic.co/guide/en/elasticsearch/guide/current/fuzziness.html][fuzziness guide]], 因為做為查無資料時使用, 因此 fuzziness 設成 *3*, 讓所有可能相關的詞都能出現, 即使相關度比較差也沒關係, 但若相關度太差不見得符合使用者預期, 這個數字未來可以調整

   * Index Schema
%INCLUDE{"FuzzyIndexSchema"}%

   * Search Schema
%INCLUDE{"FuzzySearchSchema"}%

---
---++ auto-complete

關鍵字的 auto-complete, 使用者輸入前 n 個字元, 自動顯示符合的關鍵字

SQL 語法:
<sticky>
%CODE{lang="sql" [num="10"]}% 
SELECT query,matches FROM QueryLog WHERE query LIKE :query AND id!=0 ORDER BY count DESC, create_time ASC LIMIT 10
%ENDCODE%</sticky>

---
---++ 熱門關鍵字

本週最熱門關鍵字, 取建立時間必須在 n 天以上, 依照 count 排序, 可考慮是否加入"更新時間", 排除太久未更新的關鍵字 (例如 3 天)

SQL 語法:
<sticky>
%CODE{lang="sql" [num="10"]}% 
SELECT * FROM QueryLog WHERE id!=0 AND count>1 AND create_time <= SUBDATE(create_time, INTERVAL 1 DAY) ORDER BY count DESC, create_time ASC LIMIT 10
%ENDCODE%</sticky>
